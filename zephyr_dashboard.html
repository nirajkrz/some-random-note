<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zephyr Test Management Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.18.0/plotly.min.js"></script>
    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .metric-card.success { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
        .metric-card.danger { background: linear-gradient(135deg, #f44336 0%, #da190b 100%); }
        .metric-card.warning { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); }
        .metric-card.info { background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%); }
        
        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .cycle-card {
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
        }
        
        .progress-slim {
            height: 8px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-bug-slash"></i> Zephyr Test Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <select id="projectSelect" class="form-select me-3" style="width: 200px;">
                    <option value="">Select Project...</option>
                </select>
                <select id="versionSelect" class="form-select" style="width: 200px;">
                    <option value="">Select Version...</option>
                </select>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading Zephyr data...</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display: none;">
            <!-- Key Metrics Row -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="metric-card success">
                        <div class="metric-number" id="totalTests">-</div>
                        <div class="metric-label">
                            <i class="fas fa-list-check"></i> Total Tests
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card info">
                        <div class="metric-number" id="executionRate">-</div>
                        <div class="metric-label">
                            <i class="fas fa-play-circle"></i> Execution Rate
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card success">
                        <div class="metric-number" id="passRate">-</div>
                        <div class="metric-label">
                            <i class="fas fa-check-circle"></i> Pass Rate
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card danger">
                        <div class="metric-number" id="totalDefects">-</div>
                        <div class="metric-label">
                            <i class="fas fa-exclamation-triangle"></i> Open Defects
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Type Metrics Row -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="metric-card warning">
                        <div class="metric-number" id="regressionTests">-</div>
                        <div class="metric-label">
                            <i class="fas fa-redo"></i> Regression Tests
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-card info">
                        <div class="metric-number" id="negativeTests">-</div>
                        <div class="metric-label">
                            <i class="fas fa-times-circle"></i> Negative Tests
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-card">
                        <div class="metric-number" id="testCycles">-</div>
                        <div class="metric-label">
                            <i class="fas fa-sync"></i> Test Cycles
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="chart-container">
                        <h5><i class="fas fa-chart-bar"></i> Execution Progress by Cycle</h5>
                        <div id="executionChart" style="height: 400px;"></div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-container">
                        <h5><i class="fas fa-chart-pie"></i> Test Status Distribution</h5>
                        <div id="distributionChart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>

            <!-- Cycle Details -->
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <h5><i class="fas fa-tasks"></i> Cycle Details</h5>
                        <div id="cycleDetails"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button id="refreshBtn" class="btn btn-primary btn-lg refresh-btn rounded-circle">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- Toast Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="errorToast" class="toast" role="alert">
            <div class="toast-header bg-danger text-white">
                <i class="fas fa-exclamation-circle"></i>
                <strong class="me-auto ms-2">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body"></div>
        </div>
        
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle"></i>
                <strong class="me-auto ms-2">Success</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        class ZephyrDashboard {
            constructor() {
                this.currentProject = null;
                this.currentVersion = null;
                this.init();
            }

            async init() {
                await this.loadProjects();
                this.bindEvents();
            }

            bindEvents() {
                document.getElementById('projectSelect').addEventListener('change', (e) => {
                    this.currentProject = e.target.value;
                    this.loadVersions();
                });

                document.getElementById('versionSelect').addEventListener('change', (e) => {
                    this.currentVersion = e.target.value;
                    if (this.currentProject && this.currentVersion) {
                        this.loadDashboard();
                    }
                });

                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadDashboard();
                });
            }

            async loadProjects() {
                try {
                    const response = await fetch('/api/projects');
                    const data = await response.json();
                    
                    if (data.error) {
                        this.showError(data.error);
                        return;
                    }

                    const select = document.getElementById('projectSelect');
                    select.innerHTML = '<option value="">Select Project...</option>';
                    
                    data.projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = `${project.key} - ${project.name}`;
                        select.appendChild(option);
                    });
                } catch (error) {
                    this.showError('Failed to load projects: ' + error.message);
                }
            }

            async loadVersions() {
                if (!this.currentProject) return;

                try {
                    const response = await fetch(`/api/release-status?project_id=${this.currentProject}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        this.showError(data.error);
                        return;
                    }

                    const select = document.getElementById('versionSelect');
                    select.innerHTML = '<option value="">Select Version...</option>';
                    
                    data.releases.forEach(release => {
                        const version = release.version;
                        const option = document.createElement('option');
                        option.value = version.id;
                        option.textContent = version.name;
                        select.appendChild(option);
                    });
                } catch (error) {
                    this.showError('Failed to load versions: ' + error.message);
                }
            }

            async loadDashboard() {
                if (!this.currentProject || !this.currentVersion) return;

                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('dashboardContent').style.display = 'none';

                try {
                    // Load all data in parallel
                    const [report, progress, regressionTests, negativeTests] = await Promise.all([
                        this.fetchReport(),
                        this.fetchProgress(),
                        this.fetchRegressionTests(),
                        this.fetchNegativeTests()
                    ]);

                    // Update metrics
                    this.updateMetrics(report, regressionTests, negativeTests);
                    
                    // Update charts
                    await this.updateCharts();
                    
                    // Update cycle details
                    this.updateCycleDetails(progress);

                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('dashboardContent').style.display = 'block';
                    
                    this.showSuccess('Dashboard updated successfully');
                } catch (error) {
                    this.showError('Failed to load dashboard: ' + error.message);
                    document.getElementById('loadingState').style.display = 'none';
                }
            }

            async fetchReport() {
                const response = await fetch(`/api/test-report?project_id=${this.currentProject}&version_id=${this.currentVersion}`);
                return await response.json();
            }

            async fetchProgress() {
                const response = await fetch(`/api/execution-progress?project_id=${this.currentProject}&version_id=${this.currentVersion}`);
                return await response.json();
            }

            async fetchRegressionTests() {
                const response = await fetch(`/api/regression-tests?project_id=${this.currentProject}&version_id=${this.currentVersion}`);
                return await response.json();
            }

            async fetchNegativeTests() {
                const response = await fetch(`/api/negative-tests?project_id=${this.currentProject}&version_id=${this.currentVersion}`);
                return await response.json();
            }

            updateMetrics(report, regressionTests, negativeTests) {
                const metrics = report.overall_metrics || {};
                const defects = report.defect_summary || {};

                document.getElementById('totalTests').textContent = metrics.total_tests || 0;
                document.getElementById('executionRate').textContent = (metrics.execution_rate || 0).toFixed(1) + '%';
                document.getElementById('passRate').textContent = (metrics.pass_rate || 0).toFixed(1) + '%';
                document.getElementById('totalDefects').textContent = defects.openDefects || 0;
                document.getElementById('regressionTests').textContent = regressionTests.total_regression_tests || 0;
                document.getElementById('negativeTests').textContent = negativeTests.negative_test_count || 0;
                document.getElementById('testCycles').textContent = report.cycle_breakdown?.length || 0;
            }

            async updateCharts() {
                // Execution Progress Chart
                const progressResponse = await fetch(`/api/charts/execution-progress?project_id=${this.currentProject}&version_id=${this.currentVersion}`);
                const progressData = await progressResponse.json();
                
                if (progressData.chart) {
                    Plotly.newPlot('executionChart', progressData.chart.data, progressData.chart.layout);
                }

                // Distribution Chart
                const distributionResponse = await fetch(`/api/charts/test-distribution?project_id=${this.currentProject}&version_id=${this.currentVersion}`);
                const distributionData = await distributionResponse.json();
                
                if (distributionData.chart) {
                    Plotly.newPlot('distributionChart', distributionData.chart.data, distributionData.chart.layout);
                }
            }

            updateCycleDetails(progressData) {
                const container = document.getElementById('cycleDetails');
                container.innerHTML = '';

                if (!progressData.progress) return;

                progressData.progress.forEach(cycle => {
                    const cycleCard = document.createElement('div');
                    cycleCard.className = 'card cycle-card';
                    cycleCard.innerHTML = `
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <h6 class="card-title mb-1">${cycle.cycle.name}</h6>
                                    <small class="text-muted">${cycle.cycle.description || ''}</small>
                                </div>
                                <div class="col-md-4">
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <div class="text-success fw-bold">${cycle.passed}</div>
                                            <small>Passed</small>
                                        </div>
                                        <div class="col-3">
                                            <div class="text-danger fw-bold">${cycle.failed}</div>
                                            <small>Failed</small>
                                        </div>
                                        <div class="col-3">
                                            <div class="text-warning fw-bold">${cycle.blocked}</div>
                                            <small>Blocked</small>
                                        </div>
                                        <div class="col-3">
                                            <div class="text-secondary fw-bold">${cycle.unexecuted}</div>
                                            <small>Pending</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-2">
                                        <small>Execution: ${cycle.execution_rate.toFixed(1)}%</small>
                                        <div class="progress progress-slim">
                                            <div class="progress-bar bg-info" style="width: ${cycle.execution_rate}%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <small>Pass Rate: ${cycle.pass_rate.toFixed(1)}%</small>
                                        <div class="progress progress-slim">
                                            <div class="progress-bar bg-success" style="width: ${cycle.pass_rate}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(cycleCard);
                });
            }

            showError(message) {
                const toast = document.getElementById('errorToast');
                toast.querySelector('.toast-body').textContent = message;
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            }

            showSuccess(message) {
                const toast = document.getElementById('successToast');
                toast.querySelector('.toast-body').textContent = message;
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ZephyrDashboard();
        });
    </script>
</body>
</html>
